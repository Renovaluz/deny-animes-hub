<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" href="/images/1.ico" type="image/ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS IDÊNTICO AO SEU, NENHUMA ALTERAÇÃO AQUI */
        :root {
            --akatsuki-red: #E50914; --akatsuki-red-rgb: 229, 9, 20;
            --akatsuki-dark-primary: #0B0B0B; --akatsuki-dark-secondary: #141414;
            --akatsuki-dark-tertiary: #222222; --akatsuki-text-primary: #F5F5F5;
            --akatsuki-text-secondary: #A0A0A0; --akatsuki-border-color: #303030;
            --akatsuki-glow: 0 0 8px rgba(var(--akatsuki-red-rgb), 0.7);
            --akatsuki-cloud-svg: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjRTUwOTE0IiBkPSJNNzMuMSwyNy4yYy0xLjQtNS4zLTUuOS04LjktMTEuMy04LjljLTAuOSwwLTEuOCwwLjEtMi43LDAuM2MtMi40LTYuOC04LjktMTEuNy0xNi42LTExLjdjLTcuMywwLTEzLjYsNC4yLTE2LjIsMTAuM0M5LjUsMjEuOSwyLDMxLjYsMiw0My4xYzAsMTIuMSw5LjgsMjIsMjIsMjJoNTAuMWMxMS4zLDAsMjAuNS05LjIgMjAuNS0yMC41Qzk0LjYsMzUuNiw4NS4yLDI3LjIsNzMuMSwyNy4yeiIvPjxwYXRoIGZpbGw9IiNGRkZGRkYiIGQ9Ik03My4xLDI5LjljLTEuMi00LjYtNS4xLTcuNy05LjgtNy43Yy0wLjgsMC0xLjYsMC4xLTIuMywwLjJjLTIuMS01LjktNy43LTEwLjItMTQuNC0xMC4yYy02LjMsMC0xMS44LDMuNi0xNCwxLjlDMTAuOSwyOS41LDMuNSwzOC4zLDMuNSw0OS40YzAsMTAuNSw4LjUsMTksMTksMTloNTAuMWM5LjgsMCwxNy44LTgsMTcuOC0xNy44QzkwLjMsMzguMSw4Mi45LDI5LjksNzMuMSwyOS45eiIvPjwvc3ZnPg==');
            --transition-speed: 0.3s; --border-radius: 8px; --sidebar-width: 260px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--akatsuki-dark-primary); color: var(--akatsuki-text-primary); display: flex; height: 100vh; overflow: hidden; background-image: linear-gradient(rgba(20, 20, 20, 0.95), rgba(20, 20, 20, 0.95)), url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjMDgwODA4Ij48L3JlY3Q+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMxNDE0MTQiPjwvcmVjdD4KPC9zdmc+'); }
        ::-webkit-scrollbar { width: 10px; } ::-webkit-scrollbar-track { background: var(--akatsuki-dark-secondary); } ::-webkit-scrollbar-thumb { background: var(--akatsuki-red); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #B80710; }
        .btn { padding: 0.8rem 1.5rem; border-radius: var(--border-radius); border: 2px solid var(--akatsuki-border-color); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; background-color: transparent; color: var(--akatsuki-text-primary); transition: all var(--transition-speed) ease; text-transform: uppercase; letter-spacing: 1px; }
        .btn:hover { border-color: var(--akatsuki-red); color: var(--akatsuki-red); transform: translateY(-3px); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; border-color: var(--akatsuki-border-color); color: var(--akatsuki-text-secondary); }
        .btn--primary { background-color: var(--akatsuki-red); border-color: var(--akatsuki-red); color: white; box-shadow: var(--akatsuki-glow); }
        .btn--primary:hover { background-color: #B80710; border-color: #B80710; box-shadow: 0 0 15px rgba(var(--akatsuki-red-rgb), 0.9); }
        .btn--small { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.6rem; font-weight: 500; text-transform: uppercase; font-size: 0.9rem; color: var(--akatsuki-text-secondary); }
        .input, .textarea, .select { width: 100%; background-color: var(--akatsuki-dark-primary); border: 2px solid var(--akatsuki-border-color); color: var(--akatsuki-text-primary); padding: 0.8rem 1rem; border-radius: var(--border-radius); font-size: 1rem; transition: all var(--transition-speed) ease; }
        .input:focus, .textarea:focus, .select:focus { outline: none; border-color: var(--akatsuki-red); box-shadow: 0 0 0 4px rgba(var(--akatsuki-red-rgb), 0.3); }
        .admin-sidebar { width: var(--sidebar-width); background-color: var(--akatsuki-dark-secondary); border-right: 2px solid var(--akatsuki-border-color); flex-shrink: 0; display: flex; flex-direction: column; padding: 1.5rem 1rem; position: relative; overflow: hidden; }
        .admin-sidebar::after { content: ''; position: absolute; bottom: 1rem; right: 1rem; width: 80px; height: 80px; background-image: var(--akatsuki-cloud-svg); background-size: contain; background-repeat: no-repeat; opacity: 0.5; transition: opacity var(--transition-speed) ease; }
        .admin-sidebar:hover::after { opacity: 0.8; }
        .sidebar-header { margin-bottom: 2.5rem; text-align: center; }
        .sidebar-logo { display: flex; align-items: center; justify-content: center; gap: 0.8rem; text-decoration: none; color: var(--akatsuki-text-primary); font-size: 1.6rem; font-weight: 700; transition: color var(--transition-speed) ease; }
        .sidebar-logo img { height: 45px; transition: transform var(--transition-speed) ease; }
        .sidebar-logo:hover { color: var(--akatsuki-red); } .sidebar-logo:hover img { transform: rotate(-15deg) scale(1.1); }
        .admin-nav ul { list-style: none; } .admin-nav li { margin-bottom: 0.5rem; }
        .admin-nav .nav-link { display: flex; align-items: center; gap: 1rem; padding: 1rem; text-decoration: none; color: var(--akatsuki-text-secondary); font-weight: 500; border-radius: var(--border-radius); border-left: 4px solid transparent; transition: all var(--transition-speed) ease; }
        .admin-nav .nav-link:hover { background-color: var(--akatsuki-dark-tertiary); color: var(--akatsuki-text-primary); border-left-color: var(--akatsuki-red); }
        .admin-nav .nav-link.active { background-color: var(--akatsuki-red); color: white; font-weight: 600; border-left-color: var(--akatsuki-red); box-shadow: var(--akatsuki-glow); }
        .admin-nav .nav-link .fa-fw { width: 25px; }
        .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 0.8rem; }
        .admin-main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        .main-content-header { padding: 1.5rem 2rem; background-color: var(--akatsuki-dark-secondary); border-bottom: 2px solid var(--akatsuki-border-color); }
        .main-content-header h1 { font-size: 1.8rem; }
        .main-content-body { padding: 2rem; overflow-y: auto; flex-grow: 1; position: relative; }
        .admin-panel { display: none; } .admin-panel.active { display: block; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .items-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
        .item-card { background-color: var(--akatsuki-dark-secondary); border: 2px solid var(--akatsuki-border-color); border-radius: var(--border-radius); overflow: hidden; display: flex; flex-direction: column; transition: all var(--transition-speed) ease; }
        .item-card:hover { transform: translateY(-5px); border-color: var(--akatsuki-red); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); }
        .item-card__image-link { display: block; height: 320px; overflow: hidden; }
        .item-card__image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .item-card:hover .item-card__image { transform: scale(1.05); }
        .item-card__content { padding: 1rem; flex-grow: 1; }
        .item-card__title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .item-card__actions { display: flex; gap: 0.5rem; padding: 0 1rem 1rem; }
        .admin-form-container { padding: 2.5rem; background-color: var(--akatsuki-dark-secondary); border-radius: var(--border-radius); max-width: 800px; margin: 1rem auto; border: 2px solid var(--akatsuki-border-color); }
        .admin-form-container h2 { margin-bottom: 2rem; border-bottom: 2px solid var(--akatsuki-red); padding-bottom: 0.5rem; display: inline-block; }
        .episode-manage-list { list-style: none; margin-top: 1.5rem; max-height: 400px; overflow-y: auto; padding: 0.5rem; background-color: var(--akatsuki-dark-primary); border-radius: var(--border-radius); border: 2px solid var(--akatsuki-border-color); }
        .episode-manage-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid var(--akatsuki-border-color); transition: background-color var(--transition-speed) ease; }
        .episode-manage-list li:last-child { border-bottom: none; }
        .episode-manage-list li:hover { background-color: var(--akatsuki-dark-tertiary); }
        .loading-spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: var(--akatsuki-red); display: none; z-index: 1000; }
        .main-content-body.loading .loading-spinner { display: block; }
        .main-content-body.loading .admin-panel { filter: blur(5px); opacity: 0.6; pointer-events: none; }
        #toast-notification { position: fixed; bottom: 2rem; right: 2rem; background-color: var(--akatsuki-dark-secondary); padding: 1rem 1.5rem; border-radius: var(--border-radius); z-index: 9999; border-left: 6px solid; opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); transform: translateX(120%); box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-weight: 500; }
        #toast-notification.show { opacity: 1; transform: translateX(0); }
        #toast-notification.success { border-left-color: #10B981; }
        #toast-notification.error { border-left-color: var(--akatsuki-red); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { background: var(--akatsuki-dark-secondary); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid var(--akatsuki-border-color); text-align: center; border-bottom: 4px solid var(--akatsuki-red); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .stat-card h3 { font-size: 1.2rem; color: var(--akatsuki-text-secondary); margin-bottom: 0.5rem; }
        .stat-card p { font-size: 2.5rem; font-weight: 700; color: var(--akatsuki-text-primary); }
    </style>
</head>
<body class="dark-theme">
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <a href="/admin/dashboard" class="sidebar-logo">
                <img src="/images/1.ico" alt="Logo Akatsuki">
                <span>Painel</span>
            </a>
        </div>
        <nav class="admin-nav">
            <ul>
                <li><a class="nav-link active" href="#" data-target="panel-dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Visão Geral</a></li>
                <li><a class="nav-link" href="#" data-target="panel-animes"><i class="fas fa-film fa-fw"></i> Animes</a></li>
                <li><a class="nav-link" href="#" data-target="panel-posts"><i class="fas fa-newspaper fa-fw"></i> Notícias</a></li>
                <li><a class="nav-link" href="#" data-target="panel-users"><i class="fas fa-users fa-fw"></i> Usuários</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="/" target="_blank" class="btn">Ver Site</a>
            <a href="/auth/logout" class="btn btn--primary">Sair</a>
        </div>
    </aside>

    <main class="admin-main-content">
        <header class="main-content-header">
            <h1 id="main-header-title"><i class="fas fa-tachometer-alt fa-fw"></i> Visão Geral</h1>
        </header>
        <div class="main-content-body">
            <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
            
            <div id="panel-dashboard" class="admin-panel active">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Animes</h3><p><%= totalAnimes %></p></div>
                    <div class="stat-card"><h3>Notícias</h3><p><%= totalPosts %></p></div>
                    <div class="stat-card"><h3>Usuários</h3><p><%= totalUsers %></p></div>
                </div>
            </div>
            <div id="panel-animes" class="admin-panel"></div>
            <div id="panel-posts" class="admin-panel"></div>
            <div id="panel-users" class="admin-panel"></div>
        </div>
    </main>
    
    <div id="toast-notification"></div>
    
    <!-- ======================================================= -->
    <!-- |       TEMPLATES COM A NOVA LÓGICA DE UPLOAD         | -->
    <!-- ======================================================= -->

    <template id="template-list-view">
        <div style="margin-bottom: 1.5rem;">
            <button class="btn-show-form btn btn--primary"><i class="fas fa-plus-circle"></i> Adicionar Novo</button>
        </div>
        <div class="items-grid"></div>
    </template>
    
    <!-- Formulário de Anime não precisa de alteração -->
    <template id="template-anime-form">
        <div class="admin-form-container">
            <h2 class="form-title">Adicionar Anime</h2>
            <form id="main-form" enctype="multipart/form-data">
                <input type="hidden" name="currentSlug">
                <div class="form-group"><label for="titulo">Título</label><input type="text" name="titulo" id="titulo" class="input" required></div>
                <div class="form-group"><label for="sinopse">Sinopse</label><textarea name="sinopse" id="sinopse" class="textarea" rows="5" required></textarea></div>
                <div class="form-group"><label for="anoLancamento">Ano</label><input type="number" name="anoLancamento" id="anoLancamento" class="input" required></div>
                <div class="form-group"><label for="generos">Gêneros (separados por vírgula)</label><input type="text" name="generos" id="generos" class="input" required></div>
                <div class="form-group"><label for="fileCapa">Capa (Upload)</label><input type="file" name="file" id="fileCapa" class="input" accept="image/*"></div>
                <div class="form-group"><label for="classificacao">Nota</label><input type="number" step="0.1" name="classificacao" id="classificacao" class="input"></div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn--primary">Salvar</button>
                    <button type="button" class="btn-cancel btn">Cancelar</button>
                </div>
            </form>
        </div>
    </template>

    <!-- ATUALIZAÇÃO: Template do Gerenciador de Episódios com as novas opções de fonte de vídeo -->
    <template id="template-episode-manager">
         <div class="admin-form-container">
            <h2 class="form-title-episodes">Gerenciar Episódios</h2>
            <form id="episode-add-form" enctype="multipart/form-data" style="margin-bottom: 2rem; border-bottom: 1px solid var(--akatsuki-border-color); padding-bottom: 2rem;">
                <input type="hidden" name="animeId">
                <h4>Adicionar Novo Episódio</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top:1rem;">
                    <div class="form-group"><label for="temporada">Temporada</label><input type="number" name="temporada" id="temporada" class="input" required value="1"></div>
                    <div class="form-group"><label for="numero">Número</label><input type="number" name="numero" id="numero" class="input" required></div>
                </div>
                <div class="form-group"><label for="tituloEp">Título (opcional)</label><input type="text" name="titulo" id="tituloEp" class="input"></div>
                
                <!-- >>>>> ATUALIZAÇÃO: Novas opções de fonte de vídeo <<<<< -->
                <div class="form-group">
                    <label for="tipoVideo"><i class="fas fa-link"></i> Fonte do Vídeo</label>
                    <select name="tipoVideo" id="tipoVideo" class="select">
                        <option value="upload">Upload do Dispositivo</option>
                        <option value="gdrive">Link do Google Drive</option>
                        <option value="mega">Link do Mega</option>
                        <option value="mediafire">Link do MediaFire</option>
                        <option value="iframe">Link de iFrame/Embed</option>
                    </select>
                </div>
                
                <!-- Campo para colar a URL (visível para todas as opções exceto Upload Local) -->
                <div class="form-group" id="ep-url-group">
                    <label for="urlVideo" id="url-label">URL do Vídeo</label>
                    <input type="text" name="urlVideo" id="urlVideo" class="input" placeholder="Cole o link de compartilhamento aqui">
                </div>
                
                <!-- Campo para upload do arquivo (visível apenas para Upload Local) -->
                <div class="form-group" id="ep-upload-group" style="display: none;">
                    <label for="fileVideo">Arquivo de Vídeo</label>
                    <input type="file" name="file" id="fileVideo" class="input" accept="video/mp4,video/mkv,video/x-matroska">
                </div>

                <button type="submit" class="btn btn--primary btn--small">Adicionar Episódio</button>
            </form>

            <h4>Episódios Existentes</h4>
            <ul class="episode-manage-list"></ul>
            <button type="button" class="btn-cancel btn" style="margin-top: 1.5rem;"><i class="fas fa-arrow-left"></i> Voltar</button>
        </div>
    </template>
    
    <!-- Formulário de Post não precisa de alteração -->
    <template id="template-post-form">
        <div class="admin-form-container">
            <h2 class="form-title">Adicionar Notícia</h2>
            <form id="main-form" enctype="multipart/form-data">
                <input type="hidden" name="id">
                <div class="form-group"><label for="tituloNoticia">Título</label><input type="text" name="titulo" id="tituloNoticia" class="input" required></div>
                <div class="form-group"><label for="conteudo">Conteúdo</label><textarea name="conteudo" id="conteudo" class="textarea" rows="10" required></textarea></div>
                <div class="form-group"><label for="imagemDestaque">URL da Imagem de Destaque</label><input type="text" name="imagemDestaque" id="imagemDestaque" class="input"></div>
                <div class="form-group" style="display:flex;align-items:center;gap:10px"><input type="checkbox" name="emDestaque" id="emDestaque" style="width:auto;height:auto"><label for="emDestaque" style="margin:0;">Notícia em Destaque</label></div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn--primary">Salvar</button>
                    <button type="button" class="btn-cancel btn">Cancelar</button>
                </div>
            </form>
        </div>
    </template>

    <script>
    // =======================================================
    // |   JAVASCRIPT ATUALIZADO PARA A LÓGICA EXPANDIDA     |
    // =======================================================
    document.addEventListener('DOMContentLoaded', function() {
        const adminApp = {
            // Nenhuma alteração no `dom`, `state` ou `init`
            dom: {
                mainContentBody: document.querySelector('.main-content-body'),
                navLinks: document.querySelectorAll('.admin-nav .nav-link'),
                headerTitle: document.getElementById('main-header-title'),
                toast: document.getElementById('toast-notification'),
                spinner: document.querySelector('.loading-spinner'),
            },
            state: {
                isEditing: false, editingId: null, currentView: 'list', currentPanel: 'dashboard',
            },
            init() {
                this.dom.navLinks.forEach(link => { link.addEventListener('click', e => this.handleNavClick(e)); });
                const initialPanel = window.location.hash.replace('#', '') || 'dashboard';
                const initialLink = document.querySelector(`.nav-link[data-target="panel-${initialPanel}"]`);
                if (initialLink) initialLink.click();
            },

            // Nenhuma alteração nas `utilities` e `apiCall`
            showToast(message, type = 'success') {
                this.dom.toast.textContent = message;
                this.dom.toast.className = `show ${type}`;
                setTimeout(() => { this.dom.toast.className = this.dom.toast.className.replace('show', ''); }, 4000);
            },
            setLoading(isLoading) { this.dom.mainContentBody.classList.toggle('loading', isLoading); },
            async apiCall(endpoint, options = {}) {
                this.setLoading(true);
                try {
                    const fetchOptions = { ...options };
                    if (!(fetchOptions.body instanceof FormData)) {
                        fetchOptions.headers = { 'Content-Type': 'application/json', ...fetchOptions.headers };
                        if (fetchOptions.body) { fetchOptions.body = JSON.stringify(fetchOptions.body); }
                    }
                    const response = await fetch(`/api/${endpoint}`, fetchOptions);
                    const data = await response.json();
                    if (!response.ok) { throw new Error(data.error || `Erro ${response.status}: ${response.statusText}`); }
                    return data;
                } catch (err) {
                    console.error('API Call Error:', err);
                    this.showToast(err.message, 'error');
                    return { success: false, error: err.message };
                } finally {
                    this.setLoading(false);
                }
            },
            
            // Nenhuma alteração na navegação e renderização de views
            handleNavClick(e) {
                e.preventDefault();
                const targetPanelId = e.currentTarget.dataset.target;
                this.dom.navLinks.forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');
                document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
                const activePanel = document.getElementById(targetPanelId);
                if (activePanel) activePanel.classList.add('active');
                this.dom.headerTitle.innerHTML = e.currentTarget.innerHTML;
                this.state.currentPanel = targetPanelId.replace('panel-', '');
                window.location.hash = this.state.currentPanel;
                if (this.state.currentPanel !== 'dashboard') { this.renderListView(this.state.currentPanel); }
            },
            renderView(panelId, templateId) {
                const panel = document.getElementById(panelId);
                const template = document.getElementById(templateId);
                if (panel && template) panel.innerHTML = template.innerHTML;
            },
            async renderListView(type) {
                const panelId = `panel-${type}`;
                this.renderView(panelId, 'template-list-view');
                const panel = document.getElementById(panelId);
                panel.querySelector('.btn-show-form').addEventListener('click', () => this.renderFormView(type, false));
                const result = await this.apiCall(type);
                if (!result.success) return;
                const grid = panel.querySelector('.items-grid');
                grid.innerHTML = '';
                if (!result.data || result.data.length === 0) {
                    grid.innerHTML = '<p>Nenhum item encontrado.</p>';
                    return;
                }
                if (type === 'animes') this.populateAnimeGrid(grid, result.data);
                if (type === 'posts') this.populatePostGrid(grid, result.data);
            },
            async renderFormView(type, isEditing, id = null) {
                this.state.isEditing = isEditing;
                this.state.editingId = id;
                const panelId = `panel-${type}`;
                const panel = document.getElementById(panelId);
                const formTemplateId = type === 'animes' ? 'template-anime-form' : 'template-post-form';
                this.renderView(panelId, formTemplateId);
                const form = panel.querySelector('#main-form');
                const title = panel.querySelector('.form-title');
                panel.querySelector('.btn-cancel').addEventListener('click', () => this.renderListView(type));
                if (isEditing) {
                    title.textContent = `Editar ${type === 'animes' ? 'Anime' : 'Notícia'}`;
                    const endpoint = type === 'animes' ? `animes/${id}` : `posts/slug/${id}`;
                    const { data } = await this.apiCall(endpoint);
                    if (data) {
                        for (const key in data) {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (input.type === 'checkbox') input.checked = data[key];
                                else input.value = Array.isArray(data[key]) ? data[key].join(', ') : data[key];
                            }
                        }
                        if (type === 'animes') form.querySelector('[name="currentSlug"]').value = data.slug;
                        if (type === 'posts') form.querySelector('[name="id"]').value = data.id;
                    }
                }
                form.addEventListener('submit', (e) => this.handleFormSubmit(e, type));
            },

            // Nenhuma alteração na população dos grids e no submit/delete principal
            populateAnimeGrid(grid, data) {
                data.forEach(anime => {
                    const card = document.createElement('div');
                    card.className = 'item-card'; card.dataset.slug = anime.slug;
                    card.innerHTML = `<a href="/anime/${anime.slug}" target="_blank" class="item-card__image-link"><img src="${anime.imagemCapa || '/images/placeholder_poster.png'}" class="item-card__image" alt="Capa de ${anime.titulo}"></a><div class="item-card__content"><h3 class="item-card__title">${anime.titulo}</h3></div><div class="item-card__actions"><button class="btn-edit btn btn--small"><i class="fas fa-edit"></i> Editar</button><button class="btn-episodes btn btn--small"><i class="fas fa-list-ol"></i> Eps</button><button class="btn-delete btn btn--small"><i class="fas fa-trash"></i></button></div>`;
                    card.querySelector('.btn-edit').addEventListener('click', () => this.renderFormView('animes', true, anime.slug));
                    card.querySelector('.btn-episodes').addEventListener('click', () => this.renderEpisodeManager(anime.slug));
                    card.querySelector('.btn-delete').addEventListener('click', () => this.handleDelete('animes', anime.slug));
                    grid.appendChild(card);
                });
            },
            populatePostGrid(grid, data) {
                data.forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'item-card'; card.dataset.slug = post.slug; card.dataset.id = post.id;
                    card.innerHTML = `<a href="/noticias/${post.slug}" target="_blank" class="item-card__image-link"><img src="${post.imagemDestaque || '/images/placeholder_poster.png'}" class="item-card__image" alt="Destaque de ${post.titulo}"></a><div class="item-card__content"><h3 class="item-card__title">${post.titulo}</h3></div><div class="item-card__actions"><button class="btn-edit btn btn--small"><i class="fas fa-edit"></i> Editar</button><button class="btn-delete btn btn--small"><i class="fas fa-trash"></i></button></div>`;
                    card.querySelector('.btn-edit').addEventListener('click', () => this.renderFormView('posts', true, post.slug));
                    card.querySelector('.btn-delete').addEventListener('click', () => this.handleDelete('posts', post.id));
                    grid.appendChild(card);
                });
            },
            async handleFormSubmit(e, type) {
                e.preventDefault();
                const form = e.target;
                const formObject = Object.fromEntries(new FormData(form).entries());
                if (type === 'animes') {
                    const fileInput = form.querySelector('#fileCapa');
                    if (fileInput && fileInput.files[0]) {
                        const uploadFormData = new FormData();
                        uploadFormData.append('file', fileInput.files[0]);
                        this.showToast('Enviando capa...', 'info');
                        const uploadResult = await this.apiCall('upload/capa', { method: 'POST', body: uploadFormData });
                        if (uploadResult && uploadResult.success) {
                            formObject.imagemCapa = uploadResult.filePath;
                        } else {
                            this.showToast('Falha ao enviar a imagem da capa. Verifique o console.', 'error');
                            return;
                        }
                    }
                }
                let endpoint = type; let method = 'POST';
                if (this.state.isEditing) {
                    const id = this.state.editingId; endpoint = `${type}/${id}`; method = 'PUT';
                }
                const result = await this.apiCall(endpoint, { method, body: formObject });
                if (result.success) {
                    this.showToast(`${type === 'animes' ? 'Anime' : 'Notícia'} salvo com sucesso!`);
                    this.renderListView(type);
                }
            },
            async handleDelete(type, id) {
                if (!confirm('Tem certeza que deseja deletar este item? A ação não pode ser desfeita.')) return;
                const result = await this.apiCall(`${type}/${id}`, { method: 'DELETE' });
                if (result.success) {
                    this.showToast('Item deletado com sucesso.'); this.renderListView(type);
                }
            },

            // =====================================================================
            //  |       ATUALIZAÇÃO: Lógica do Gerenciador de Episódios             |
            // =====================================================================
            async renderEpisodeManager(animeSlug) {
                const panel = document.getElementById('panel-animes');
                this.renderView('panel-animes', 'template-episode-manager');
                panel.querySelector('.btn-cancel').addEventListener('click', () => this.renderListView('animes'));

                const { data: anime } = await this.apiCall(`animes/${animeSlug}`);
                if (!anime) return;

                panel.querySelector('.form-title-episodes').textContent = `Episódios de: ${anime.titulo}`;
                const form = panel.querySelector('#episode-add-form');
                form.querySelector('[name="animeId"]').value = anime.id;

                const list = panel.querySelector('.episode-manage-list');
                list.innerHTML = '';
                const sortedEpisodes = (anime.episodios || []).sort((a,b) => a.temporada - b.temporada || a.numero - b.numero);

                if (sortedEpisodes.length === 0) {
                    list.innerHTML = '<li>Nenhum episódio cadastrado.</li>';
                } else {
                    sortedEpisodes.forEach(ep => {
                        const li = document.createElement('li'); li.dataset.id = ep.id;
                        li.innerHTML = `<span>T${ep.temporada} E${ep.numero} - ${ep.titulo || 'Sem título'}</span><button class="btn-delete-ep btn btn--small btn--primary"><i class="fas fa-trash"></i></button>`;
                        li.querySelector('.btn-delete-ep').addEventListener('click', async () => {
                            if(!confirm('Deletar episódio?')) return;
                            const res = await this.apiCall(`episodios/${ep.id}`, {method: 'DELETE'});
                            if(res.success) {
                                this.showToast('Episódio deletado');
                                this.renderEpisodeManager(animeSlug);
                            }
                        });
                        list.appendChild(li);
                    });
                }
                
                // >>>>> ATUALIZAÇÃO: Lógica para controlar a visibilidade dos campos de upload/url <<<<<
                const typeSelect = form.querySelector('#tipoVideo');
                const urlGroup = form.querySelector('#ep-url-group');
                const uploadGroup = form.querySelector('#ep-upload-group');
                const urlInput = form.querySelector('#urlVideo');
                const fileInput = form.querySelector('#fileVideo');

                typeSelect.addEventListener('change', () => {
                    const selectedValue = typeSelect.value;
                    
                    if (selectedValue === 'upload') {
                        uploadGroup.style.display = 'block';
                        urlGroup.style.display = 'none';
                        fileInput.required = true;
                        urlInput.required = false;
                    } else {
                        uploadGroup.style.display = 'none';
                        urlGroup.style.display = 'block';
                        fileInput.required = false;
                        urlInput.required = true;
                    }
                });
                
                // Dispara o evento 'change' na primeira carga para definir o estado inicial correto
                typeSelect.dispatchEvent(new Event('change'));

                form.addEventListener('submit', async e => {
                    e.preventDefault();
                    
                    // Usamos FormData para lidar com upload de arquivos nativamente.
                    const formData = new FormData(form);
                    
                    // A rota do backend já espera o 'processForm' que lida com o arquivo,
                    // então podemos enviar o formData diretamente, seja para upload ou link.
                    const result = await this.apiCall('episodios', { method: 'POST', body: formData });
                    
                    if(result.success){
                        this.showToast('Episódio adicionado!');
                        this.renderEpisodeManager(animeSlug);
                    }
                });
            }
        };

        adminApp.init();
    });
    </script>
</body>
</html>