<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central de Notícias Akatsuki</title>
<!-- Font Awesome para ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- Estilos Principais -->
<style>
    /*
    ================================================================
    TEMA DUAL (ESCURO E CLARO)
    Otimizado para clareza e consistência.
    ================================================================
    */

    :root {
        /* MODO ESCURO (PADRÃO) */
        --color-primary: #E50914; 
        --color-primary-hover: #F40612;
        --color-background: #0b0b0f;
        --color-surface: #1c1c1e;
        --color-surface-hover: #2c2c2e;
        --color-border: #38383a;
        --color-text-primary: #f1f1f1;
        --color-text-secondary: #a1a1aa;
        --color-text-on-surface: #f8f9fa;
        --color-text-secondary-on-surface: rgba(248, 249, 250, 0.7);
        --card-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        --card-hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.5), 0 0 15px rgba(229, 9, 20, 0.2);
        
        --modal-surface: #141418;
        --modal-border: #2a2a2e;
        --modal-text-primary: #f1f1f1;
        --modal-text-secondary: #a1a1aa;
    }

    body.light-mode {
        /* MODO CLARO */
        --color-primary: #d90429;
        --color-primary-hover: #E53935;
        --color-background: #f8f9fa;
        --color-surface: #ffffff;
        --color-surface-hover: #f1f1f1;
        --color-border: #dee2e6;
        --color-text-primary: #18181b;
        --color-text-secondary: #6c757d;
        --color-text-on-surface: #18181b;
        --color-text-secondary-on-surface: #6c757d;
        --card-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);

        --modal-surface: #fdfdfd;
        --modal-border: #e9ecef;
        --modal-text-primary: #212529;
        --modal-text-secondary: #6c757d;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--color-background);
        color: var(--color-text-primary);
        margin: 0;
        padding-top: 70px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.modal-open { overflow: hidden; }

    .container {
        width: 100%;
        max-width: 1320px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* HEADER E NAVEGAÇÃO */
    .main-header {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 70px;
        background-color: rgba(11, 11, 15, 0.8);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--color-border);
        z-index: 900;
        transition: background-color 0.3s, border-color 0.3s;
    }
    body.light-mode .main-header { background-color: rgba(255, 255, 255, 0.8); }
    
    .main-header .container {
        display: flex; align-items: center; justify-content: space-between; height: 100%;
    }
    
    .header-logo {
        font-size: 1.5rem; font-weight: bold;
        color: var(--color-text-primary); text-decoration: none; transition: color 0.3s;
    }
    .header-logo .fa-cloud { color: var(--color-primary); }
    
    #theme-toggle-btn {
        background: var(--color-surface); color: var(--color-text-on-surface);
        border: 1px solid var(--color-border);
        width: 40px; height: 40px; border-radius: 50%;
        cursor: pointer; font-size: 1.2rem;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.3s ease;
    }
    #theme-toggle-btn:hover { transform: scale(1.1) rotate(15deg); color: var(--color-primary); }
    .theme-icon.fa-sun { display: none; }
    body.light-mode .theme-icon.fa-sun { display: block; }
    body.light-mode .theme-icon.fa-moon { display: none; }

    /* LAYOUT PRINCIPAL */
    .main-layout {
        display: grid; grid-template-columns: 1fr;
        gap: 40px; padding-top: 50px; padding-bottom: 50px;
    }
    @media (min-width: 992px) { .main-layout { grid-template-columns: minmax(0, 2.5fr) minmax(0, 1fr); } }
    
    .section-title-main {
        font-size: 1.8rem; margin-bottom: 25px; padding-bottom: 12px;
        border-bottom: 2px solid var(--color-primary);
        display: flex; align-items: center; gap: 12px;
        color: var(--color-text-primary);
        transition: color 0.3s, border-color 0.3s;
    }
    
    /* GRID DE NOTÍCIAS */
    .news-grid { display: grid; gap: 15px; }
    @media (max-width: 767px) {
        .news-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .news-card { background: transparent; border: 2px solid transparent; border-radius: 8px; box-shadow: none; }
        .news-card:hover { border-color: var(--color-primary); transform: scale(1.05); }
        .news-card__image-container { aspect-ratio: 1/1; border-radius: 6px; overflow: hidden; }
        .news-card__content, .news-card__overlay .news-card__readmore { display: none; }
        .news-card:hover .news-card__overlay { opacity: 1; background: rgba(0,0,0,0.6); }
    }
    @media (min-width: 768px) {
        .news-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .news-card {
            background: var(--color-surface); color: var(--color-text-on-surface);
            border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid var(--color-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, background-color 0.3s;
            text-decoration: none; box-shadow: var(--card-shadow);
        }
        .news-card:hover { transform: translateY(-5px); box-shadow: var(--card-hover-shadow); }
        .news-card__image-container { position: relative; aspect-ratio: 16/10; }
        .news-card__image-container img { width: 100%; height: 100%; object-fit: cover; }
        .news-card__overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .news-card:hover .news-card__overlay { opacity: 1; }
        .news-card__readmore {
            width: 55px; height: 55px; background: var(--color-primary);
            border-radius: 50%; border: none; color: white; font-size: 1.6rem;
            display: flex; align-items: center; justify-content: center;
        }
        .news-card__content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .news-card__category { font-size: 0.8rem; font-weight: bold; color: var(--color-primary); margin-bottom: 10px; text-transform: uppercase; }
        .news-card__title { font-size: 1.15rem; margin: 0; flex-grow: 1; line-height: 1.4; color: var(--color-text-on-surface); transition: color 0.3s; }
        .news-card__meta {
            display: flex; justify-content: space-between;
            color: var(--color-text-secondary-on-surface); font-size: 0.85em;
            margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--color-border);
            transition: color 0.3s, border-color 0.3s;
        }
    }

    /* SIDEBAR */
    .sidebar-widget {
        background: var(--color-surface); padding: 25px; border-radius: 8px; margin-bottom: 40px;
        border: 1px solid var(--color-border); box-shadow: var(--card-shadow);
        transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
    }
    .sidebar-widget h3 { margin: 0 0 25px 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; color: var(--color-primary); }
    .ranking-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
    .ranking-list a {
        display: flex; align-items: center; gap: 15px; text-decoration: none;
        background: var(--color-background); padding: 10px; border-radius: 6px;
        transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
        border: 1px solid var(--color-border);
    }
    .ranking-list a:hover { background-color: var(--color-surface-hover); transform: translateX(5px); }
    .ranking-list img { width: 50px; min-width: 50px; height: 75px; object-fit: cover; border-radius: 4px; }
    .rank-info .title { display: block; color: var(--color-text-primary); font-weight: 600; margin-bottom: 5px; transition: color 0.3s;}
    .rank-info .details { font-size: 0.85em; color: var(--color-text-secondary); display: flex; gap: 15px; align-items: center; transition: color 0.3s;}

    /* ELEMENTOS DE UI GENÉRICOS */
    .btn {
        padding: 10px 22px; border-radius: 6px; border: 1px solid transparent;
        cursor: pointer; font-weight: 600; transition: all 0.2s ease;
        display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 0.95rem;
    }
    .btn--primary { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
    .btn--primary:hover { background-color: var(--color-primary-hover); border-color: var(--color-primary-hover); transform: translateY(-2px); }
    .btn--secondary { background-color: transparent; color: var(--color-text-primary); border: 1px solid var(--color-border); }
    .btn--secondary:hover { background-color: var(--color-surface); color: var(--color-text-on-surface); }
    
    .status-message { padding: 40px 20px; text-align: center; color: var(--color-text-secondary); font-size: 1.1rem; transition: color 0.3s; }
    .status-message .fa-spinner { color: var(--color-primary); margin-right: 10px; }
    .animated-section { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    .animated-section.is-visible { opacity: 1; transform: translateY(0); }

    /*
    ================================================================
    ESTRUTURA DE MODAL GENÉRICA
    ================================================================
    */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; visibility: hidden;
        transition: opacity 0.4s ease, visibility 0s 0.4s;
    }
    .modal.active { opacity: 1; visibility: visible; transition-delay: 0s; }
    
    .modal__content {
        background: var(--modal-surface);
        box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        border-radius: 12px;
        transform: scale(0.9);
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.3s;
        position: relative;
    }
    .modal.active .modal__content { transform: scale(1); }
    
    .modal__close {
        position: absolute; top: 15px; right: 15px;
        background: rgba(0,0,0,0.2); border: 1px solid var(--color-border);
        border-radius: 50%; width: 40px; height: 40px;
        font-size: 24px; color: var(--modal-text-secondary); cursor: pointer;
        transition: all 0.3s ease;
        display: flex; align-items: center; justify-content: center;
        z-index: 100;
    }
    body.light-mode .modal__close { color: var(--modal-text-secondary); background: rgba(0,0,0,0.05); }
    .modal__close:hover { background: var(--color-primary); border-color: var(--color-primary); color: #fff; transform: scale(1.1) rotate(90deg); }

    .scrollbar-styled { scrollbar-width: thin; scrollbar-color: var(--color-primary) var(--modal-border); }
    .scrollbar-styled::-webkit-scrollbar { width: 8px; }
    .scrollbar-styled::-webkit-scrollbar-track { background: var(--modal-border); }
    .scrollbar-styled::-webkit-scrollbar-thumb { background-color: var(--color-primary); border-radius: 4px; }
    
    /*
    ================================================================
    MODAL-PÁGINA DE NOTÍCIAS (VÍDEO)
    ================================================================
    */
    #news-page-modal .modal__content {
        width: 95vw; max-width: 1400px;
        height: 95vh;
        display: flex; flex-direction: column;
        overflow: hidden;
    }
    .news-page__body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 40px 50px;
    }
    .news-page__header { padding-bottom: 25px; border-bottom: 1px solid var(--color-border); margin-bottom: 30px; transition: border-color 0.3s;}
    .news-page__title {
        font-size: 2.2rem; margin: 0; line-height: 1.3;
        color: var(--modal-text-primary); transition: color 0.3s;
    }
    #video-player-container {
        position: relative; padding-bottom: 56.25%; height: 0;
        border-radius: 10px; overflow: hidden; margin-bottom: 40px;
        background-color: #000;
    }
    #video-player-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

    .news-page__meta-grid {
        display: grid; grid-template-columns: 1fr auto; gap: 30px;
        align-items: start;
    }
    
    .news-page__section-title {
        font-size: 1.5rem; color: var(--modal-text-primary);
        margin: 0 0 20px 0; transition: color 0.3s;
    }

    /* Formulário de Comentário */
    .comment-form { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
    .comment-form textarea {
        width: 100%; min-height: 80px; padding: 12px;
        border: 1px solid var(--color-border); border-radius: 6px;
        background: var(--color-background); color: var(--modal-text-primary);
        font-family: inherit; font-size: 1rem; resize: vertical;
        transition: all 0.3s;
    }
    .comment-form textarea:focus { border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.15); outline: none; }
    .comment-form__footer { display: flex; justify-content: space-between; align-items: center; }
    .comment-form__disclaimer { font-size: 0.8rem; color: var(--modal-text-secondary); font-style: italic; }
    
    /* Lista de Comentários */
    #comments-list-container { display: flex; flex-direction: column; gap: 25px; }
    .comment-card { display: flex; gap: 15px; }
    .comment-author-avatar img { width: 40px; height: 40px; border-radius: 50%; }
    .comment-author-name { font-weight: 600; color: var(--modal-text-primary); margin-right: 10px; transition: color 0.3s; }
    .comment-date { font-size: 0.8em; color: var(--modal-text-secondary); transition: color 0.3s; }
    .comment-text { color: var(--modal-text-secondary); line-height: 1.6; margin-top: 5px; transition: color 0.3s; }

    /* Barra Lateral da Página de Notícias */
    .news-page__sidebar { display: flex; flex-direction: column; gap: 30px; }
    .sidebar-box { background: var(--color-surface); padding: 20px; border-radius: 8px; border: 1px solid var(--color-border); transition: all 0.3s;}
    .sidebar-box__title { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--modal-text-primary); transition: color 0.3s;}
    .social-share-buttons { display: flex; gap: 10px; }
    .social-share-buttons a {
        width: 38px; height: 38px; border-radius: 50%;
        display: inline-flex; align-items: center; justify-content: center;
        text-decoration: none; color: #fff; font-size: 1.1rem;
        transition: transform 0.2s;
    }
    .social-share-buttons a:hover { transform: scale(1.1); }
    .social-share-buttons .fa-facebook-f { background: #1877F2; }
    .social-share-buttons .fa-twitter { background: #1DA1F2; }
    .social-share-buttons .fa-whatsapp { background: #25D366; }
    
    /*
    ================================================================
    MODAL DE EXPLORADOR DE CATEGORIAS
    ================================================================
    */
    #category-explorer-modal { z-index: 1050; } /* Garante que fique sobre o outro modal */
    #category-explorer-modal .modal__content {
        width: 90vw; max-width: 900px;
        height: 90vh;
        display: flex; flex-direction: column;
        padding: 30px;
    }
    .category-explorer__header { flex-shrink: 0; }
    .category-explorer__title { font-size: 1.8rem; margin: 0 0 20px; color: var(--modal-text-primary); transition: color 0.3s; }
    .category-explorer__tags {
        display: flex; flex-wrap: wrap; gap: 10px;
        margin-bottom: 20px; padding-bottom: 20px;
        border-bottom: 1px solid var(--color-border);
        transition: border-color 0.3s;
    }
    .category-tag {
        background-color: var(--color-surface); color: var(--modal-text-secondary);
        padding: 8px 18px; border-radius: 20px; font-size: 0.9em;
        cursor: pointer; border: 1px solid var(--color-border);
        transition: all 0.2s;
    }
    .category-tag:hover { background-color: var(--color-primary-hover); color: #fff; border-color: var(--color-primary-hover); }
    .category-tag.active { background-color: var(--color-primary); color: #fff; border-color: var(--color-primary); font-weight: bold; }
    
    .category-explorer__results-grid {
        flex-grow: 1; overflow-y: auto;
        display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 20px;
    }
    .category-explorer__results-grid .news-card {
        min-height: 180px;
    }
</style>
</head>
<body>

<!-- HEADER PRINCIPAL -->
<header class="main-header">
    <div class="container">
        <a href="#" class="header-logo">
            <i class="fas fa-cloud"></i> Akatsuki Hub
        </a>
        <button id="theme-toggle-btn" aria-label="Alternar tema">
            <i class="fas fa-moon theme-icon"></i>
            <i class="fas fa-sun theme-icon"></i>
        </button>
    </div>
</header>

<!-- LAYOUT PRINCIPAL DO CONTEÚDO -->
<div class="main-layout container" role="main">
    <main class="main-content-area">
        <section id="external-news" class="animated-section" aria-labelledby="section-title-web">
            <h2 id="section-title-web" class="section-title-main"><i class="fas fa-globe-americas"></i> Destaques da Web</h2>
            <div class="news-grid" id="external-news-container">
                <p class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando destaques da web...</p>
            </div>
        </section>
    </main>
    
    <aside class="sidebar" role="complementary">
        <div id="top-animes-widget" class="sidebar-widget animated-section" aria-labelledby="section-title-animes">
            <h3 id="section-title-animes"><i class="fas fa-fire-alt"></i> Top Animes da Temporada</h3>
            <ol class="ranking-list" id="top-anime-list">
                <li class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando animes...</li>
            </ol>
        </div>
        <div id="top-movies-widget" class="sidebar-widget animated-section" aria-labelledby="section-title-movies">
            <h3 id="section-title-movies"><i class="fas fa-film"></i> Filmes Populares</h3>
            <ol class="ranking-list" id="top-movies-list">
                <li class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando filmes...</li>
            </ol>
        </div>
    </aside>
</div>

<!-- MODAL-PÁGINA DE NOTÍCIAS (NOVO E ROBUSTO) -->
<div id="news-page-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="news-page-title">
    <div class="modal__content">
        <button class="modal__close" aria-label="Fechar">×</button>
        <div class="news-page__body scrollbar-styled">
            <header class="news-page__header">
                <h2 id="news-page-title" class="news-page__title">Carregando notícia...</h2>
            </header>
            
            <div id="video-player-container"></div>
            
            <div class="news-page__meta-grid">
                <main class="news-page__main-content">
                    <section id="comment-section">
                        <h3 class="news-page__section-title">Deixe seu Comentário</h3>
                        <form id="comment-form" class="comment-form">
                            <textarea id="comment-textarea" placeholder="O que você achou deste vídeo?" required></textarea>
                            <div class="comment-form__footer">
                                <span class="comment-form__disclaimer">Seu comentário é temporário e visível apenas para você.</span>
                                <button type="submit" class="btn btn--primary">
                                    <i class="fas fa-paper-plane"></i> Comentar
                                </button>
                            </div>
                        </form>
                    </section>
                    
                    <section id="comments-list-section">
                        <h3 class="news-page__section-title">Comentários do YouTube</h3>
                        <div id="comments-list-container">
                             <p class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando comentários...</p>
                        </div>
                    </section>
                </main>
                
                <aside class="news-page__sidebar">
                    <div class="sidebar-box">
                        <h4 class="sidebar-box__title">Compartilhe</h4>
                        <div class="social-share-buttons">
                            <a href="#" target="_blank" class="social-share-link" data-platform="facebook" title="Compartilhar no Facebook"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" target="_blank" class="social-share-link" data-platform="twitter" title="Compartilhar no Twitter"><i class="fab fa-twitter"></i></a>
                            <a href="#" target="_blank" class="social-share-link" data-platform="whatsapp" title="Compartilhar no WhatsApp"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    </div>
                    <div class="sidebar-box">
                        <h4 class="sidebar-box__title">Navegação</h4>
                        <button id="open-category-explorer" class="btn btn--secondary" style="width:100%;">
                            <i class="fas fa-compass"></i> Explorar por Categoria
                        </button>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</div>

<!-- MODAL EXPLORADOR DE CATEGORIAS (NOVO) -->
<div id="category-explorer-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="category-explorer-title">
    <div class="modal__content">
        <button class="modal__close" aria-label="Fechar">×</button>
        <div class="category-explorer__header">
            <h2 id="category-explorer-title" class="category-explorer__title">Explorar Categorias</h2>
            <div id="category-explorer-tags" class="category-explorer__tags scrollbar-styled">
                <p class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando categorias...</p>
            </div>
        </div>
        <div id="category-explorer-results-grid" class="category-explorer__results-grid scrollbar-styled">
            <p class="status-message">Selecione uma categoria para ver as notícias.</p>
        </div>
    </div>
</div>

<!-- FOOTER -->
<footer class="main-footer">
    <div class="container">
        <p>© 2025 Central Akatsuki. Todos os direitos reservados.</p>
        <p>Desenvolvido com a força do Sharingan. Dados fornecidos por Jikan, TMDb e YouTube.</p>
    </div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURAÇÕES E CONSTANTES GLOBAIS ---
    const JIKAN_API = 'https://api.jikan.moe/v4';
    const YOUTUBE_API_KEY = 'SUA_CHAVE_API_DO_YOUTUBE_AQUI'; // INSIRA SUA CHAVE AQUI
    const YOUTUBE_API_URL = 'https://www.googleapis.com/youtube/v3';
    const PLACEHOLDER_IMG = 'https://via.placeholder.com/300x450/1c1c1e/a1a1aa?text=Sem+Imagem';

    // --- ELEMENTOS DO DOM ---
    const body = document.body;
    const newsPageModal = document.getElementById('news-page-modal');
    const categoryExplorerModal = document.getElementById('category-explorer-modal');

    // --- LÓGICA DO ALTERNADOR DE TEMA ---
    const themeToggleButton = document.getElementById('theme-toggle-btn');
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'light') body.classList.add('light-mode');
    
    themeToggleButton.addEventListener('click', () => {
        body.classList.toggle('light-mode');
        localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
    });

    // --- FUNÇÃO AUXILIAR DE FETCH ---
    const fetchData = async (url) => {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            return await res.json();
        } catch (error) {
            console.error(`Falha ao buscar dados de ${url}:`, error);
            return null;
        }
    };
    
    // --- LÓGICA GENÉRICA DOS MODAIS ---
    const openModal = (modal) => {
        if (!modal) return;
        modal.classList.add('active');
        body.classList.add('modal-open');
    }
    
    const closeModal = (modal) => {
        if (!modal) return;
        modal.classList.remove('active');
        if (!document.querySelector('.modal.active')) {
            body.classList.remove('modal-open');
        }
        if (modal.id === 'news-page-modal') {
            const iframeContainer = modal.querySelector('#video-player-container');
            if (iframeContainer) iframeContainer.innerHTML = '';
        }
    }

    document.querySelectorAll('.modal').forEach(modal => {
        modal.querySelector('.modal__close').addEventListener('click', () => closeModal(modal));
    });

    // --- FUNÇÃO PARA EXTRAIR ID DO VÍDEO DO YOUTUBE ---
    function extractYouTubeId(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // --- CARREGAMENTO INICIAL DO CONTEÚDO DA PÁGINA ---
    async function fetchAndDisplayInitialNews() {
        const container = document.getElementById('external-news-container');
        if (!container) return;
        const newsData = await fetchData(`${JIKAN_API}/watch/promos`);
        
        if (!newsData?.data || newsData.data.length === 0) {
            container.innerHTML = `<p class="status-message">Nenhum destaque encontrado.</p>`;
            return;
        }
        renderNewsGrid(container, newsData.data.slice(0, 12));
    }
    
    function renderNewsGrid(container, newsItems) {
        container.innerHTML = newsItems.map(item => {
            const promo = item.entry;
            const imageUrl = promo.images?.jpg?.large_image_url || PLACEHOLDER_IMG;
            const videoId = extractYouTubeId(item.trailer.url);
            if (!videoId) return '';

            return `
                <a href="#" class="news-card open-news-page-modal" data-video-id="${videoId}" data-video-title="${promo.title}">
                    <div class="news-card__image-container">
                        <img src="${imageUrl}" alt="Capa de ${promo.title}" loading="lazy" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMG}';"/>
                        <div class="news-card__overlay"><span class="news-card__readmore"><i class="fab fa-youtube"></i></span></div>
                    </div>
                    <div class="news-card__content">
                        <span class="news-card__category">Trailer</span>
                        <h4 class="news-card__title">${promo.title}</h4>
                        <div class="news-card__meta"><span><i class="fas fa-play-circle"></i> Assistir agora</span></div>
                    </div>
                </a>
            `;
        }).join('');
    }

    // --- LÓGICA DO MODAL-PÁGINA DE NOTÍCIAS ---
    const newsPageTitleEl = document.getElementById('news-page-title');
    const playerContainer = document.getElementById('video-player-container');
    const commentsContainer = document.getElementById('comments-list-container');
    const commentForm = document.getElementById('comment-form');

    async function loadNewsPage(videoId, videoTitle) {
        openModal(newsPageModal);

        // Resetar estado
        newsPageTitleEl.textContent = videoTitle;
        playerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        commentsContainer.innerHTML = `<p class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando comentários...</p>`;
        commentForm.reset();
        
        updateShareLinks(videoId, videoTitle);
        await fetchYouTubeComments(videoId);
    }

    function updateShareLinks(videoId, videoTitle) {
        const url = `https://www.youtube.com/watch?v=${videoId}`;
        const text = `Confira este vídeo: ${videoTitle}`;
        newsPageModal.querySelector('.social-share-link[data-platform="facebook"]').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
        newsPageModal.querySelector('.social-share-link[data-platform="twitter"]').href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
        newsPageModal.querySelector('.social-share-link[data-platform="whatsapp"]').href = `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + url)}`;
    }

    async function fetchYouTubeComments(videoId) {
        if (YOUTUBE_API_KEY === 'SUA_CHAVE_API_DO_YOUTUBE_AQUI') {
            commentsContainer.innerHTML = `<p class="status-message" style="text-align: left;">Para exibir os comentários, uma chave da API do YouTube é necessária no código.</p>`;
            return;
        }
        const url = `${YOUTUBE_API_URL}/commentThreads?part=snippet&videoId=${videoId}&key=${YOUTUBE_API_KEY}&order=relevance&maxResults=20`;
        const data = await fetchData(url);
        
        if (!data?.items || data.items.length === 0) {
            commentsContainer.innerHTML = `<p class="status-message">Nenhum comentário encontrado.</p>`;
            return;
        }
        
        commentsContainer.innerHTML = data.items.map(item => renderComment(item.snippet.topLevelComment.snippet)).join('');
    }

    function renderComment(comment) {
        return `
            <div class="comment-card">
                <div class="comment-author-avatar"><img src="${comment.authorProfileImageUrl}" alt="${comment.authorDisplayName}"></div>
                <div class="comment-body">
                    <div><span class="comment-author-name">${comment.authorDisplayName}</span><span class="comment-date">${new Date(comment.publishedAt).toLocaleDateString('pt-BR')}</span></div>
                    <div class="comment-text">${comment.textDisplay}</div>
                </div>
            </div>`;
    }

    commentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const textarea = document.getElementById('comment-textarea');
        if (!textarea.value.trim()) return;

        const fakeComment = {
            authorProfileImageUrl: 'https://i.pravatar.cc/40?u=user',
            authorDisplayName: 'Você',
            publishedAt: new Date().toISOString(),
            textDisplay: textarea.value.trim().replace(/\n/g, '<br>')
        };
        
        // Remove mensagem de "nenhum comentário" se existir
        const statusMessage = commentsContainer.querySelector('.status-message');
        if (statusMessage) statusMessage.remove();
        
        commentsContainer.insertAdjacentHTML('afterbegin', renderComment(fakeComment));
        textarea.value = '';
    });

    // --- LÓGICA DO MODAL EXPLORADOR DE CATEGORIAS ---
    const categoryTagsContainer = document.getElementById('category-explorer-tags');
    const categoryResultsGrid = document.getElementById('category-explorer-results-grid');

    document.getElementById('open-category-explorer').addEventListener('click', async () => {
        openModal(categoryExplorerModal);
        categoryTagsContainer.innerHTML = `<p class="status-message"><i class="fas fa-spinner fa-spin"></i> Carregando...</p>`;
        categoryResultsGrid.innerHTML = `<p class="status-message">Selecione uma categoria.</p>`;
        
        const genresData = await fetchData(`${JIKAN_API}/genres/anime`);
        if(genresData?.data) {
            categoryTagsContainer.innerHTML = genresData.data.map(genre => 
                `<button class="category-tag" data-genre-id="${genre.mal_id}">${genre.name}</button>`
            ).join('');
        }
    });

    categoryTagsContainer.addEventListener('click', async (e) => {
        const tag = e.target.closest('.category-tag');
        if (!tag) return;
        
        const genreId = tag.dataset.genreId;
        categoryResultsGrid.innerHTML = `<p class="status-message"><i class="fas fa-spinner fa-spin"></i> Buscando notícias...</p>`;
        
        // Desativa outras tags ativas
        categoryTagsContainer.querySelectorAll('.active').forEach(t => t.classList.remove('active'));
        tag.classList.add('active');
        
        // A API Jikan não permite filtrar /watch/promos por gênero.
        // Como alternativa, buscamos animes do gênero e filtramos aqueles com vídeo.
        const newsData = await fetchData(`${JIKAN_API}/anime?genres=${genreId}&limit=24`);
        const newsWithVideo = newsData?.data.filter(item => item.trailer?.youtube_id) || [];

        if(newsWithVideo.length > 0) {
            const items = newsWithVideo.map(item => ({
                entry: item,
                trailer: { url: item.trailer.url }
            }));
            renderNewsGrid(categoryResultsGrid, items);
        } else {
            categoryResultsGrid.innerHTML = `<p class="status-message">Nenhuma notícia com vídeo encontrada para esta categoria.</p>`;
        }
    });

    // --- DELEGAÇÃO DE EVENTOS PRINCIPAL ---
    body.addEventListener('click', async (e) => {
        // Abrir Modal de Notícias
        const openNewsBtn = e.target.closest('.open-news-page-modal');
        if (openNewsBtn) {
            e.preventDefault();
            const { videoId, videoTitle } = openNewsBtn.dataset;
            // Se o explorador de categorias estiver aberto, feche-o primeiro
            if(categoryExplorerModal.classList.contains('active')) {
                closeModal(categoryExplorerModal);
            }
            await loadNewsPage(videoId, videoTitle);
        }
    });

    // --- INICIALIZAÇÃO GERAL ---
    fetchAndDisplayInitialNews();
    // As outras funções de sidebar podem ser adicionadas aqui se necessário
});
</script>
</body>
</html>